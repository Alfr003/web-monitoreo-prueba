// =================== API (Render) ===================
const API_BASE = "https://api-monitoreo-nube.onrender.com";
const ZONA = "Z1";

// Para "cargar más"
let LIMITE = 500;     // empieza con 500 filas
const PASO = 500;     // cada "cargar más" suma 500

// =================== DOM ===================
const selMes = document.getElementById("filtroMes");
const selDia = document.getElementById("filtroDia");
const inpHora = document.getElementById("filtroHora");

const btnAplicar = document.getElementById("btnAplicar");
const btnLimpiar = document.getElementById("btnLimpiar");
const btnExcelTodo = document.getElementById("btnExcelTodo");
const btnExcelMes = document.getElementById("btnExcelMes");
const btnCargarMas = document.getElementById("btnCargarMas");

const estado = document.getElementById("estado");
const tbody = document.querySelector("#tablaHistoricos tbody");

// Resumen (mes -> [dias])
let DIAS_POR_MES = {};

// =================== Helpers ===================
function setEstado(msg) {
  if (estado) estado.textContent = msg || "";
}

function limpiarTabla() {
  tbody.innerHTML = "";
}

function addRow(r) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${r.fecha || ""}</td>
    <td>${r.hora || ""}</td>
    <td>${(r.temperatura ?? "")}</td>
    <td>${(r.humedad ?? "")}</td>
    <td>${r.zona || "Z1"}</td>
  `;
  tbody.appendChild(tr);
}

// Convierte "HH:MM" -> "HH"
function horaToHH(timeValue) {
  if (!timeValue) return "";
  // timeValue viene "11:30"
  return String(timeValue).slice(0, 2);
}

// =================== Cargar resumen (meses/días) ===================
async function cargarResumen() {
  setEstado("Cargando meses disponibles...");
  try {
    const url = `${API_BASE}/api/historial_resumen?t=${Date.now()}`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const meses = data.meses || [];
    DIAS_POR_MES = data.dias_por_mes || {};

    // llena meses
    selMes.innerHTML = `<option value="">Todos</option>`;
    meses.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;      // "2026-01"
      opt.textContent = m;
      selMes.appendChild(opt);
    });

    // día deshabilitado al inicio
    selDia.value = "";
    selDia.disabled = true;

    btnExcelMes.disabled = true;

    setEstado(meses.length ? "" : "Aún no hay meses disponibles (no hay historial).");
  } catch (e) {
    console.error(e);
    setEstado("Error cargando resumen. Revisa consola (F12).");
  }
}

// =================== Llenar días según mes ===================
function actualizarDiasPorMes() {
  const mes = selMes.value;

  selDia.innerHTML = `<option value="">Todos</option>`;

  if (!mes) {
    selDia.value = "";
    selDia.disabled = true;
    btnExcelMes.disabled = true;
    return;
  }

  const dias = DIAS_POR_MES[mes] || [];
  dias.forEach(d => {
    const opt = document.createElement("option");
    opt.value = d;        // "2026-01-28"
    opt.textContent = d;
    selDia.appendChild(opt);
  });

  selDia.disabled = false;
  btnExcelMes.disabled = false;
}

// =================== Consultar historial filtrado ===================
async function cargarTabla() {
  const mes = selMes.value || "";
  const dia = selDia.value || "";
  const hora = horaToHH(inpHora.value); // API usa HH

  setEstado("Cargando tabla...");
  limpiarTabla();

  try {
    const params = new URLSearchParams();
    params.set("zona", ZONA);
    if (mes) params.set("mes", mes);
    if (dia) params.set("dia", dia);
    if (hora) params.set("hora", hora);
    params.set("n", String(LIMITE));
    params.set("t", String(Date.now()));

    const url = `${API_BASE}/api/historial_filtro?${params.toString()}`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const rows = await res.json();

    if (!Array.isArray(rows) || rows.length === 0) {
      setEstado("No hay registros con esos filtros.");
      btnCargarMas.style.display = "none";
      return;
    }

    rows.forEach(addRow);

    setEstado(`Mostrando ${rows.length} registros (límite actual: ${LIMITE}).`);

    // Mostrar "cargar más" si parece que hay más
    btnCargarMas.style.display = (rows.length >= LIMITE) ? "inline-block" : "none";

  } catch (e) {
    console.error(e);
    setEstado("Error cargando tabla. Revisa consola (F12).");
    btnCargarMas.style.display = "none";
  }
}

// =================== Descargas ===================
function descargarTodo() {
  // Exporta TODO (sin mes)
  const url = `${API_BASE}/api/historial_export?zona=${encodeURIComponent(ZONA)}&t=${Date.now()}`;
  window.open(url, "_blank");
}

function descargarMes() {
  const mes = selMes.value;
  if (!mes) return;
  const url = `${API_BASE}/api/historial_export?zona=${encodeURIComponent(ZONA)}&mes=${encodeURIComponent(mes)}&t=${Date.now()}`;
  window.open(url, "_blank");
}

// =================== Eventos ===================
selMes.addEventListener("change", () => {
  actualizarDiasPorMes();
});

btnAplicar.addEventListener("click", () => {
  LIMITE = 500; // reset al aplicar filtros
  cargarTabla();
});

btnLimpiar.addEventListener("click", () => {
  selMes.value = "";
  actualizarDiasPorMes(); // resetea día/habilitado
  selDia.value = "";
  inpHora.value = "";
  LIMITE = 500;
  cargarTabla();
});

btnExcelTodo.addEventListener("click", descargarTodo);
btnExcelMes.addEventListener("click", descargarMes);

btnCargarMas.addEventListener("click", () => {
  LIMITE += PASO;
  cargarTabla();
});

// =================== Init ===================
(async function init() {
  await cargarResumen();
  await cargarTabla(); // carga todo al entrar
})();
